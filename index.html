<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mezo Plays Pokémon – ChainPlays UI</title>
  <style>
    /* Mezo brand theme: charcoal + hot pink accent */
    :root {
      --bg: #0b0a0e;            /* page background (near-black with a hint of magenta) */
      --card: #101018;          /* cards & panels */
      --text: #f3f4f6;          /* primary text */
      --sub: #b6bac7;           /* secondary text */
      --accent: #ff0050;        /* Mezo pink */
      --edge: #2a0d1a;          /* borders (pink-tinted charcoal) */
      --edge-soft: #1a0a12;     /* subtle borders */
      --surface: #0f0e15;       /* inputs/buttons base */
      --surface-2: #14121a;     /* badges/mono blocks */
    }

    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .wrap { max-width:880px; margin:40px auto; padding:24px; }
    .card { background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    h1 { font-size:28px; margin:0 0 8px; }
    p { color:var(--sub); margin:0 0 16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    button, input { height:44px; border-radius:10px; border:1px solid var(--edge); background:var(--surface); color:var(--text); padding:0 14px; font-weight:600; }
    select { height:44px; border-radius:10px; border:1px solid var(--edge); background:var(--surface); color:var(--text); padding:0 14px; font-weight:600; }
    /* override inline styles on the chain select if present */
    select#chain { background: var(--surface) !important; border-color: var(--edge) !important; color: var(--text) !important; }

    button { cursor:pointer; }
    button.primary { background:linear-gradient(180deg, #ff2b6a, #ff0050); border-color:#b8003b; color:#fff; }
    button:hover { filter:brightness(1.06); }

    .pad { display:grid; grid-template-columns:repeat(3,100px); gap:10px; justify-content:center; margin-top:10px; }
    .pad button { height:64px; font-size:18px; background:linear-gradient(180deg, #ff2b6a, #ff0050); border-color:#b8003b; color:#fff; }
    .pad button:disabled { opacity:.65; cursor:wait; }
    .keys { display:grid; grid-template-columns:repeat(2,100px); gap:10px; justify-content:center; margin-top:10px; }
    .keys button { background:linear-gradient(180deg, #ff2b6a, #ff0050); border-color:#b8003b; color:#fff; }
    .keys button:disabled { opacity:.65; cursor:wait; }
    .keys { display:grid; grid-template-columns:repeat(2,100px); gap:10px; justify-content:center; margin-top:10px; }

    .stat { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:var(--surface-2); border:1px solid var(--edge-soft); padding:10px 12px; border-radius:10px; white-space:pre-line; }
    .badge { padding:4px 10px; border-radius:999px; background:var(--surface-2); border:1px solid var(--edge); color:var(--sub); font-size:12px; }
    .spacer { height:16px; }
    a { color: var(--accent); text-decoration: none; }
    .grid { display:grid; gap:12px; }
    .two { grid-template-columns:1fr 1fr; }
    @media (max-width:840px){ .two { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Mezo Plays Pokémon</h1>
      <p>Send on-chain inputs to the <code>ChainPlays</code> contract deployed on Mezo Mainnet. Each press calls <code>move(cmd, memo)</code> and emits a <code>Move</code> event.</p>

      <div class="row" style="margin-bottom:8px">
        <label class="badge">Contract</label>
        <input id="contract" value="0x7c8A35C98Bf46a67324Af3F54aD027DBE2138E98" style="min-width:320px" />
        <label class="badge">Chain</label>
        <select id="chain" style="height:44px;border-radius:10px;background:#0e1520;color:var(--text);border:1px solid #2a3a4f;">
          <option value="31612" selected>Mezo Mainnet (31612)</option>
          <option value="31611">Mezo Testnet (31611)</option>
        </select>
        <button id="saveCfg">Save</button>
      </div>

      <!-- Smart Wallet Panel (simplified) -->
      <div class="row" id="walletPanel1" style="margin-bottom:8px">
        <label class="badge">Owner</label>
        <div id="ownerAddr" class="stat" style="min-width:300px">—</div>
        <label class="badge">Owner Balance</label>
        <div id="ownerBal" class="stat">—</div>
      </div>
      <div class="row" id="walletPanel2" style="margin-bottom:8px">
        <label class="badge">Smart Wallet</label>
        <input id="walletAddr" readonly style="min-width:340px" placeholder="(not created)" />
        <button id="btnCreateWallet" class="primary">Create My Wallet</button>
      </div>
      <div class="row" id="walletPanel3" style="margin-bottom:8px; display:none;">
        <label class="badge">Wallet Balance</label>
        <div id="walletBal" class="stat">—</div>
        <input id="fundAmt" placeholder="Amount (BTC)" style="width:180px" />
        <button id="btnFund" class="primary">Fund</button>
        <button id="btnRefresh" class="secondary">Refresh</button>
      </div>

      <div class="row">
        <button id="connect" class="primary">Connect Wallet</button>
        <div id="acct" class="stat">Not connected</div>
        <div id="net" class="badge">Network: —</div>
        <a id="expl" class="badge" href="https://explorer.mezo.org/address/0x7c8A35C98Bf46a67324Af3F54aD027DBE2138E98" target="_blank" rel="noreferrer">Open in Explorer</a>
      </div>

      <div class="spacer"></div>
      <div class="grid two">
        <div>
          <div class="pad">
            <div></div>
            <button data-cmd="0">↑ Up</button>
            <div></div>
            <button data-cmd="2">← Left</button>
            <button data-cmd="1">↓ Down</button>
            <button data-cmd="3">→ Right</button>
          </div>
          <div class="keys">
            <button data-cmd="4">A</button>
            <button data-cmd="5">B</button>
            <button data-cmd="6">Start</button>
            <button data-cmd="7">Select</button>
          </div>
        </div>
        <div>
          <div class="row">
            <input id="memo" placeholder="Optional memo (e.g., 'Go!')" style="flex:1;min-width:260px" />
            <button id="send" class="primary">Send Last Click</button>
          </div>
          <div class="spacer"></div>
          <div class="grid">
            <div class="stat" id="status">Status: idle</div>
            <div class="stat" id="gas">Gas est.: —</div>
            <div class="stat" id="last">Last tx: —</div>
            <div class="stat" id="events">Recent events (client-side): none</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ethers v5 (UMD) for injected wallets like MetaMask/Rabby) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js">  
  // --- Mezo Mainnet connect helper (forces 31612) ---
  async function ensureInjectedMezo(){
    const eth = window.ethereum;
    if (!eth) { alert('No injected wallet found. Install MetaMask/Rabby.'); throw new Error('no-wallet'); }
    eip1193 = eth;
    await eth.request({ method: 'eth_requestAccounts' });

    const desired = 31612; // Mezo Mainnet
    const toHex = (n) => '0x' + n.toString(16);
    try {
      const currentHex = await eth.request({ method: 'eth_chainId' });
      const current = parseInt(currentHex, 16);
      if (current !== desired) {
        try {
          await eth.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: toHex(desired) }] });
        } catch (e) {
          if (e.code === 4902 || e?.data?.originalError?.code === 4902) {
            await eth.request({ method: 'wallet_addEthereumChain', params: [{
              chainId: '0x7B7C', // 31612
              chainName: 'Mezo Mainnet',
              nativeCurrency: { name: 'Bitcoin', symbol: 'BTC', decimals: 18 },
              rpcUrls: ['https://mainnet.mezo.public.validationcloud.io'],
              blockExplorerUrls: ['https://explorer.mezo.org']
            }]});
            await eth.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x7B7C' }] });
          } else { throw e; }
        }
      }
    } catch (e) { console.error('chain switch/add failed', e); throw e; }

    // Ethers v6 provider
    provider = new ethers.BrowserProvider(eip1193);
    signer = await provider.getSigner();
    return { addr: await signer.getAddress() };
  }
</script>

  <script>
    (function(){
      const ethers = window.ethers; // v5 UMD

      // === Mezo chain config ===
      const MEZO_MAINNET = 31612;
      const MEZO_PARAMS = {
        chainId: '0x7B7C',
        chainName: 'Mezo Mainnet',
        nativeCurrency: { name: 'Bitcoin', symbol: 'BTC', decimals: 18 },
        rpcUrls: ['https://mainnet.mezo.public.validationcloud.io'],
        blockExplorerUrls: ['https://explorer.mezo.org']
      };

      // === ABI ===
      const ABI = [
        'function move(uint8 cmd, string memo)',
        'event Move(address indexed sender, uint8 cmd, uint256 weight, string memo)'
      ];

      // GasTankWallet ABI (subset)
      const WABI = [
        'function deposit() payable',
        'function withdraw(uint256 amount, address payable to)',
        'function setRelayer(address r)',
        'function relayer() view returns (address)',
        'function owner() view returns (address)',
        'function relayMove(uint8 cmd, string memo)',
        'function sessionKey() view returns (address)',
        'function sessionKeyExpiry() view returns (uint64)'
      ];

      // === GasTankFactory config ===
      // Set this to your deployed factory on Mezo Mainnet for a seamless 1-click experience.
      // When non-empty, the UI hides the manual Factory field and uses this address automatically.
      const FACTORY_ADDR_MAINNET = "0x72EC50a581AF9A5e656Aa4FA1785AfF6444892C6"; // TODO: paste your deployed factory address here

      // GasTankFactory ABI (supports registry + payable create)
      const FABI = [
        'function walletOf(address owner) view returns (address)',
        'function create(address owner, address chainPlays) payable returns (address)',
        'function createAndDeposit(address owner, address chainPlays) payable returns (address)',
        'event WalletCreated(address indexed wallet, address indexed owner, uint256 initialDeposit)'
      ];

      // === DOM ===
      const $ = (id) => document.getElementById(id);
      const connectBtn   = $('connect');
      const padButtons   = Array.from(document.querySelectorAll('[data-cmd]'));
      const acctEl       = $('acct');
      const netEl        = $('net');
      const statusEl     = $('status');
      const gasEl        = $('gas');
      const lastEl       = $('last');
      const eventsEl     = $('events');
      const contractInput= $('contract');
      const chainSelect  = $('chain');

      // smart wallet DOM (simplified)
      const ownerAddrEl     = document.getElementById('ownerAddr');
      const ownerBalEl      = document.getElementById('ownerBal');
      const walletAddrEl    = document.getElementById('walletAddr');
      const btnCreateWallet = document.getElementById('btnCreateWallet');
      const walletBalEl     = document.getElementById('walletBal');
      const fundAmtEl       = document.getElementById('fundAmt');
      const btnFund         = document.getElementById('btnFund');
      const btnRefresh      = document.getElementById('btnRefresh');

      // if factory constant is set and we're on Mezo Mainnet, hide manual field

      let provider, signer, contract, lastCmd = null, sending = false;
      let walletContract = null; // GasTankWallet instance

      function say(msg){ statusEl.textContent = msg; }

      function explorerBase(){
        return Number(chainSelect.value) === MEZO_MAINNET ? 'https://explorer.mezo.org' : 'https://explorer.test.mezo.org';
      }
      function updateExplorerLink(){
        const addr = contractInput.value.trim();
        if (!addr) return;
        $('expl').href = `${explorerBase()}/address/${addr}`;
      }
      updateExplorerLink();

      async function ensureInjectedMezo(){
        if (!window.ethereum){
          say('No injected wallet found. Install MetaMask/Rabby/OKX or open in the wallet\'s in-app browser.');
          throw new Error('no-injected-wallet');
        }
        if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        const accs = await provider.listAccounts();
        if (accs.length === 0) await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        const addr = await signer.getAddress();
        const net  = await provider.getNetwork();
        acctEl.textContent = `Player: ${addr}`;
        netEl.textContent  = `Network: ${net.chainId}`;
        // ensure Mezo (31612)
        if (net.chainId !== MEZO_MAINNET){
          try {
            await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: MEZO_PARAMS.chainId }] });
          } catch (e){
            if (e.code === 4902 || String(e.message).includes('Unrecognized chain')){
              await window.ethereum.request({ method:'wallet_addEthereumChain', params:[MEZO_PARAMS] });
            } else {
              throw e;
            }
          }
          // refresh provider network state
          provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
          signer = provider.getSigner();
          const net2 = await provider.getNetwork();
          netEl.textContent = `Network: ${net2.chainId}`;
        }
        return { addr: await signer.getAddress() };
      }

      function getContract(){
        const addr = contractInput.value.trim();
        if (!addr) throw new Error('Missing contract address');
        return new ethers.Contract(addr, ABI, signer || provider);
      }

      function getWallet(){
        const waddr = walletAddrEl?.value?.trim();
        if (!waddr) throw new Error('Missing smart wallet address');
        return new ethers.Contract(waddr, WABI, signer || provider);
      }

      async function onConnect(){
        try {
          say('Connecting…');
          const { addr } = await ensureInjectedMezo();
          contract = getContract().connect(signer);
          acctEl.textContent = `Player: ${addr}`;
          ownerAddrEl.textContent = addr;

          // show network id
          const net = await provider.getNetwork();
          netEl.textContent = `Network: ${net.chainId}`;

          // auto-detect wallet via factory
          try {
            const fab = new ethers.Contract(FACTORY_ADDR_MAINNET, FABI, signer);
            const existing = await fab.walletOf(addr);
            if (existing && existing !== '0x0000000000000000000000000000000000000000') {
              walletAddrEl.value = existing;
              walletContract = new ethers.Contract(existing, WABI, signer);
              document.getElementById('walletPanel3').style.display = 'flex';
              btnCreateWallet.style.display = 'none';
            } else {
              walletAddrEl.value = '';
              document.getElementById('walletPanel3').style.display = 'none';
              btnCreateWallet.style.display = 'inline-block';
            }
          } catch {}

          // events stream (best-effort)
          try {
            contract.on('Move', (sender, cmd, weight, memo, ev) => {
              appendEvent({ sender, cmd: Number(cmd), memo, txHash: ev.transactionHash });
            });
          } catch {}

          await refreshOwnerBalance();
          await refreshWalletBalance();
          say('Status: connected');
        } catch (err){
          console.error(err);
          say('Connect error: ' + (err?.message || err));
        }
      }

      function appendEvent(e){
        const now = new Date().toLocaleTimeString();
        const line = `[${now}] ${e.sender} → cmd=${e.cmd} memo="${e.memo}" tx=${(e.txHash||'').slice(0,10)||'—'}`;
        const prev = eventsEl.textContent;
        eventsEl.textContent = prev === 'Recent events (client-side): none' ? line : prev + "\n" + line;
      }

      async function estimate(){
        try {
          if (!contract) return;
          const memo = $('memo').value || '';
          const gas  = await contract.estimateGas.move(lastCmd, memo);
          const fee  = await provider.getFeeData();
          const price= fee.gasPrice || fee.maxFeePerGas || ethers.BigNumber.from(0);
          const cost = gas.mul(price);
          gasEl.textContent = `Gas est.: ~${gas.toString()} @ ${ethers.utils.formatUnits(price, 9)} gwei → cost ≈ ${ethers.utils.formatUnits(cost, 18)} BTC`;
        } catch {
          gasEl.textContent = 'Gas est.: (failed to estimate — will send anyway)';
        }
      }

      async function send(cmd, memo){
        if (walletAddrEl.value) {
          // Prefer smart wallet if present
          try{
            if (!walletContract) walletContract = new ethers.Contract(walletAddrEl.value, WABI, signer);
            say('Sending via smart wallet…');
            const tx = await walletContract.relayMove(cmd, memo, { gasLimit: 500000 });
            lastEl.textContent = 'Last tx: ' + tx.hash;
            const rc = await tx.wait();
            say('Smart wallet relayed in block ' + rc.blockNumber);
          } catch(e){
            console.error(e);
            say('Smart wallet error: ' + (e?.message || e));
          }
          return;
        }
        // Fallback to direct call
        try {
          say('Sending…');
          const tx = await contract.move(cmd, memo, { gasLimit: 300000 });
          lastEl.textContent = 'Last tx: ' + tx.hash;
          const rc = await tx.wait();
          say('Mined in block ' + rc.blockNumber);
        } catch (e){
          console.error(e);
          say('Error: ' + (e?.error?.message || e?.data?.message || e?.message || e));
        }
      }

      // Rebuild provider on chain change to avoid ethers v5 NETWORK_ERROR
      if (window.ethereum?.on) {
        window.ethereum.on('chainChanged', async (_cid) => {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
            signer = provider.getSigner();
            const net = await provider.getNetwork();
            netEl.textContent = `Network: ${net.chainId}`;
          } catch (e) {
            statusEl.textContent = 'Reconnected after chain change';
          }
        });
      }

      // UI wiring
      connectBtn.onclick = onConnect;
      function setPadDisabled(disabled){
        padButtons.forEach(b=>b.disabled = !!disabled);
      }

      padButtons.forEach(btn => btn.addEventListener('click', async () => {
        try {
          lastCmd = Number(btn.dataset.cmd);
          const memo = $('memo').value || '';
          if (!contract) { alert('Connect first.'); return; }
          setPadDisabled(true);
          await send(lastCmd, memo);
        } finally {
          setPadDisabled(false);
        }
      }));
      $('send').onclick = async () => {
        if (lastCmd === null){ alert('Press a command button first.'); return; }
        await send(lastCmd, $('memo').value || '');
      };

      // Balances + wallet actions (simple)
      async function refreshOwnerBalance(){
        try{
          const bal = await provider.getBalance(await signer.getAddress());
          ownerBalEl.textContent = ethers.utils.formatUnits(bal, 18) + ' BTC';
        } catch {}
      }
      async function refreshWalletBalance(){
        try{
          const waddr = walletAddrEl.value.trim();
          if (!waddr) { walletBalEl.textContent = '—'; return; }
          const bal = await provider.getBalance(waddr);
          walletBalEl.textContent = ethers.utils.formatUnits(bal, 18) + ' BTC';
        } catch { walletBalEl.textContent = '—'; }
      }

      btnCreateWallet?.addEventListener('click', async () => {
        try {
          await ensureInjectedMezo();
          const owner = await signer.getAddress();
          const cp    = contractInput.value.trim();
          const fab   = new ethers.Contract(FACTORY_ADDR_MAINNET, FABI, signer);
          say('Creating wallet…');
          const tx = await fab.create(owner, cp);
          const rc = await tx.wait();
          let wallet;
          try { const ev = rc.events?.find(e=>e.event==='WalletCreated'); if (ev?.args?.wallet) wallet = ev.args.wallet; } catch {}
          if (!wallet) wallet = await fab.walletOf(owner);
          walletAddrEl.value = wallet;
          walletContract = new ethers.Contract(wallet, WABI, signer);
          document.getElementById('walletPanel3').style.display = 'flex';
          btnCreateWallet.style.display = 'none';
          say('Wallet ready: ' + wallet);
          await refreshWalletBalance();
        } catch(e){ say('Create failed: ' + (e?.message || e)); }
      });

      btnFund?.addEventListener('click', async () => {
        try {
          if (!walletAddrEl.value) return alert('Create a wallet first');
          const amt = fundAmtEl.value.trim(); if (!amt) return alert('Enter amount');
          const w = new ethers.Contract(walletAddrEl.value, WABI, signer);
          say('Funding wallet…');
          const tx = await w.deposit({ value: ethers.utils.parseUnits(amt, 18) });
          await tx.wait();
          await refreshWalletBalance();
          say('Funded');
        } catch(e){ say('Fund failed: ' + (e?.message || e)); }
      });

      btnRefresh?.addEventListener('click', async () => {
        await refreshOwnerBalance();
        await refreshWalletBalance();
      });

      // --- Keyboard controls ---
      function keyToCmd(evt){
        const k = evt.key;
        if (k === 'ArrowUp') return 0;     // Up
        if (k === 'ArrowDown') return 1;   // Down
        if (k === 'ArrowLeft') return 2;   // Left
        if (k === 'ArrowRight') return 3;  // Right
        if (k && k.length === 1 && k.toLowerCase() === 'a') return 4; // A
        if (k && k.length === 1 && k.toLowerCase() === 'b') return 5; // B
        // Optional quality-of-life mappings:
        if (k === 'Enter') return 6;       // Start
        if (k === 'Shift') return 7;       // Select
        return null;
      }

      document.addEventListener('keydown', async (evt) => {
        const cmd = keyToCmd(evt);
        if (cmd === null) return;
        // Prevent the page from scrolling on arrow keys etc.
        evt.preventDefault();
        if (!contract) { alert('Connect first.'); return; }
        if (evt.repeat || sending) return; // ignore key auto-repeat and concurrent sends
        try {
          sending = true;
          setPadDisabled(true);
          await send(cmd, $('memo').value || '');
        } finally {
          sending = false;
          setPadDisabled(false);
        }
      });
    })();
  </script>
</body>
</html>
